<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Schema Editor</title>

    <!-- link rel="stylesheet" href="css/normalize.css" / -->
    <link rel="stylesheet" href="css/columns.css" />

    <link rel="stylesheet" href="css/common.css" />
    <link rel="stylesheet" type="text/css" href="css/jquery-ui.min.css" />

    <script src="js/lib/marked.js"></script>

    <!-- mustache template compiler -->
    <script src="js/lib/hogan-3.0.2.js"></script>

    <script src="js/lib/jquery-1.10.2.js"></script>
    <script src="js/lib/jquery-ui.min.js" type="text/javascript" charset="utf-8"></script>

    <!-- date formatting -->
    <script src="js/lib/moment.js"></script>

    <!-- Schema Editor Specific -->
    <script src="js/schema-edit.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/sparql-templates.js"></script>
    <script src="js/sparql-connector.js"></script>
    <!--
    <script src="js/foowiki/config.js"></script>
    
    <script src="js/foowiki/html-templates.js"></script>
   
    <script src="js/foowiki/core.js"></script>
    <script src="js/foowiki/index.js"></script>
   
-->

    <!-- TODO move scripts to mostly external files -->
    <script type="text/javascript" language="javascript">
        $(function () {

            //    setupErrorHandling();
            //  spinner();
            var uri = queryString["uri"];
            // console.log("URI="+uri);
            uri = encodeURI(uri);

            $("#currentResource").text(uri);
            SchemaEdit.setCurrentResource(uri);
            SchemaEdit.setupButtons();

            makeClassesList();
            makePropertiesList();


            var uri = queryString["uri"];



            if (uri) { // TODO need to check if this if() is working
                // console.log("URI="+uri);

                uri = encodeURI(uri);

                var buildEditor = function (json) {
                    // console.log("json = " + JSON.stringify(json, null, 4));
                    // return;
                    for (var i = 0; i < json.length; i++) {
                        var current = json[i];
                        var node = $("<div></div>");
                        var property = $("<a/>");
                        property.attr("href", current["p"]);
                        node.append(property);
                        property.text(current["p"]);
                        var deleteButton = $("<button class='delete'>Delete</button>");
                        var triple = "<" + SchemaEdit.getCurrentResource() + "> "; // subject
                        triple += "<" + current["p"] + "> "; // predicate/property

                        deleteButton.attr("data-triple", triple); // stick resource data in attribute
                        property.append(deleteButton);

                        node.append($("<br/>"));

                        var value = $("<div>what default?</div>"); // needed for bnodes?

                        if (current.type == "literal") {
                            value = $("<input type='text' value='" + current["o"] + "'></input>");
                            console.log("IS LITERAL");
                            triple += "\"\"\"" + current["o"] + "\"\"\" ."; // object
                        }
                        if (current.type == "uri") {
                            value = $("<a />");
                            value.attr("href", current["o"]);
                            console.log("IS URI");
                            node.append($("<button class='inline'>Change</button>"));
                        }


                        node.append(value);

                        value.text(current["o"]);
                        var update = $("<button>Update</button>");
                        node.append(update);
                        $("#currentResource").append("<br/><strong>Property</strong>").append(node);
                    }
                }
                SchemaEdit.getResource(uri, buildEditor);

            }

            /*
            $("#upload-button").click(function () {
                var data = new FormData($("#upload-file").val());
                console.log("DATA = " + data);
                $.ajax({
                    url: config.sparqlUpdateEndpoint,
                    type: 'POST',
                    data: ({
                        update: data
                    }),
                    //    contentType: "application/sparql-update",
                    processData: false,
                    contentType: false
                });
                //    e.preventDefault();
            });
*/
            //$('#editButton').click(function () {
            //   window.location.href = window.location.href.replace("page.html", "edit.html");
            //   return false;
            //});
            function makeClassesList() {
                var callback = function (json) {
                    makeList(json, $("#classes"));
                }
                var classList = SchemaEdit.listClasses(callback);
            };

            function makePropertiesList() {
                var callback = function (json) {
                    makeList(json, $("#properties"));
                }
                var propertiesList = SchemaEdit.listProperties(callback);
            }

            function makeList(json, target) {
                var listElement = $("<ul class='block'/>");
                target.append(listElement);
                for (var i = 0; i < json.length; i++) {
                    var uri = json[i]["uri"];
                    var split = uri.split("/");
                    var name = split[split.length - 1];
                    var itemElement = $("<li></li>");
                    var split = window.location.href.split("?");
                    var url = split[0] + "?uri=" + encodeURI(uri);
                    var aElement = $("<a/>").attr("href", url);
                    if (name.length > 5) {
                        name = name.substring(0, 5); // TODO remove
                        aElement.text(name);
                        itemElement.append(aElement);
                        listElement.append(itemElement);
                    }
                }
            }
        });
    </script>

    <script type="text/javascript" language="javascript">
    </script>

</head>

<body>
    <header>
        <hgroup>
            <div class="heading">Schema Editor</div>
            <strong>
                Current Resource : <span id="currentResource"></span></strong>
        </hgroup>
    </header>

    <nav>
        <h2>Classes</h2>
        <div id="classes"></div>
        <h2>Properties</h2>
        <div id="properties"></div>
    </nav>

    <main>


        <!--
        <div class="endpoints">
            <a href="#hide1" class="hide" id="hide1">+</a>
            <a href="#show1" class="show" id="show1">-</a>
            <div class="minimal">Endpoint Settings</div>
            <div class="full">
                <div>
                    <label for="endpointHost">Endpoint Host</label>
                    <input id="endpointHost" type='text' value=''></input>
                </div>
                <div>
                    <label for="queryPath">Query Path</label>
                    <input id='queryPath' type='text' value=''></input>
                </div>
                <div id="updatePath">
                    <label for="updatePath">Update Path</label>
                    <input id='updatePath' type='text' value=''></input>
                </div>
            </div>
        </div>
        <br/>
        <hr />
  
-->


        <!-- form id="upload-form" enctype="multipart/form-data">
            <input type="file" id="upload-file" name="upload" />
            <button type="submit" id="upload-button">Upload Turtle</button>
            </form -->

        <h3>Upload RDF</h3>
        <!-- TODO change this from config -->
        <form action="http://localhost:3333/schema-edit/upload" enctype="multipart/form-data" method="post">
            <!-- TODO move to config (bypass Fuseki) -->
            <!-- onsubmit="window.location.href = 'index.html'; return false;" -->
            <!-- TODO UNSET FILE NAME ?? -->
            <input id="filename" type="file" name="UNSET FILE NAME" size="40" multiple="">
            <label for='graphName'>Graph</label>
            <input name="graph" id="graphName" size="20" value="http://schema.org/terms/" />
            <br />
            <input type="submit" value="Upload">
        </form>
        <h3>Export Turtle</h3>
        <button id="turtle">Export</button>
        </div>
    </main>

    <aside>
        <h2>History</h2>
    </aside>

    <footer>

    </footer>

</body>

</html>